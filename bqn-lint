#!/usr/bin/env bqn

c  â‡ â€¢Import "deps/color.bqn"
s  â‡ â€¢Import "deps/string.bqn"
fs â‡ â€¢Import "deps/file_system.bqn"
fn â‡ â€¢Import "deps/fun.bqn"

nl     â† @+10
colors â† c.Greenâ€¿c.Yellowâ€¿c.Red

title â† {
    a â† "â†‘â†‘â†‘" # arrows
    nlâˆ¾(âˆ¾colors{ğ•ğ•©}Â¨a)âˆ¾c.Green " bqn-lint "âˆ¾(âˆ¾colors{ğ•ğ•©}Â¨â—‹âŒ½a)âˆ¾nl
}

replacements â† âŸ¨âŸ¨"0â‰ â‰ ", "Ã—â‰ "âŸ©,
                âŸ¨"0<â‰ ", "Ã—â‰ "âŸ©,
                âŸ¨"Â¬=",  "â‰ "âŸ©, # TODO this could break trains
                âŸ¨"Â¬âˆ˜=",  "â‰ "âŸ©,
                âŸ¨"(Â¬=)",  "â‰ "âŸ©âŸ© # TODO add more

CheckReplacement â† { fâ€¿(tâ€¿r)ğ•Šiâ€¿l:
    m â† tâ·l
    { Â¬âˆ¨Â´m ? "" ;
        â€¢Out "In "âˆ¾fâˆ¾":"
        â€¢Out "  Line "âˆ¾(â€¢Fmt i)âˆ¾":"
        â€¢Out "    "âˆ¾(c.Red t) s.Join t s.Split l
        â€¢Out "    "âˆ¾ c.Yellow " â†‘"âŠËœt fn.FindFull l
        â€¢Out "    "âˆ¾(" "/ËœâŠ‘/m)âˆ¾(c.Yellow "this can be: ")âˆ¾c.Green r
        â€¢Out âŸ¨âŸ©
    }
}

LintSingleFile â† { ğ•Šfile:
    l â† â€¢file.Lines ğ•©
    {(fileâ‹ˆğ•©)âŠ¸CheckReplacementÂ¨(â†•âˆ˜â‰ âŠ¸(â‹ˆÂ¨)l)}Â¨replacements
}

FixSingleFile â† { ğ•Šf:
    l  â† â€¢file.Lines ğ•©
    ts â† âŠ‘Â¨replacements # targets
    n  â† +Â´âˆ¾â¥Štsâ·âŒœl
    ğ•© â€¢file.Lines l {tâ€¿rğ•Šğ•©: (r s.Join t s.Split âŠ¢)Â¨ğ•©}Â´ replacements
    { Ã—n ? â€¢Out "In "âˆ¾fâˆ¾": "âˆ¾c.Green (â€¢Fmt n)âˆ¾" fix"âˆ¾{ n > 1 ? "es" ; "" } ; âˆ }
}

main â† {
    â€¢Out title
    (c.Red "Must provide directory") ! 0â‰ â‰ â€¢args
    d   â† { "."â‰¡0âŠ‘â€¢args ? â€¢wdpath ; 0âŠ‘â€¢args } # directory
    fix â† 1<â‰ â€¢args                            # verbose
    { fix ? (c.Red "2nd argument must be '--fix' (if specified)") ! "--fix"â‰¡âŠ‘1âŠâ€¢args ; âˆ }
    f â† fs.ListRecursiveBQNFiles d
    { fix ? FixSingleFileÂ¨f ; LintSingleFileÂ¨f }
}

main
